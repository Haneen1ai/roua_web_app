<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>مساعدك الصوتي</title>
<style>
  body {
    margin: 0;
    background-color: #001633; /* كحلي غامق */
    overflow: hidden;
  }

  #logo {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 150px;
    height: auto;
    z-index: 10;
  }

  canvas {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 300px;
    z-index: 5;
  }

  #controls {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 20;
  }

  button {
    padding: 10px 20px;
    margin-left: 10px;
  }
</style>
</head>
<body>
<img id="logo" src="{{ url_for('static', filename='logo.png') }}" alt="شعار">
<canvas id="visualizer"></canvas>

<div id="controls">
  <button id="startBtn">بدء المحادثة</button>
  <button id="stopBtn">إيقاف</button>
</div>

<!-- صوت البوت -->
<audio id="agent-audio" autoplay playsinline></audio>

<script type="module">
  import { Conversation } from "https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.5.0/+esm";

  const startBtn   = document.getElementById('startBtn');
  const stopBtn    = document.getElementById('stopBtn');
  const agentAudio = document.getElementById('agent-audio');

  let convo = null;

  async function start() {
    const tokenRes = await fetch('/conversation-token');
    if (!tokenRes.ok) throw new Error('فشل جلب التوكن');
    const conversationToken = await tokenRes.text();

    convo = await Conversation.startSession({
      conversationToken,
      connectionType: "webrtc",
    });

    const remoteStream =
      (convo.getRemoteMediaStream && convo.getRemoteMediaStream()) ||
      (convo.getRemoteStream && convo.getRemoteStream()) || null;

    if (remoteStream) {
      agentAudio.srcObject = remoteStream;
      await agentAudio.play().catch(()=>{});
    }

    startBtn.disabled = true;
    stopBtn.disabled  = false;
  }

  async function stop() {
    if (convo) { await convo.endSession(); convo = null; }
    startBtn.disabled = false;
    stopBtn.disabled  = true;
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
</script>

<!-- موجات متحركة بشكل مستمر -->
<script>
  const canvas = document.getElementById('visualizer');
  const ctx = canvas.getContext('2d');

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = 300;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  let step = 0;

  function drawWaves() {
    requestAnimationFrame(drawWaves);

    ctx.fillStyle = '#001633'; // خلفية كحلي
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#ffffff'; // موجات بيضاء

    // نرسم موجتين مختلفتين
    for (let j = 0; j < 2; j++) {
      ctx.beginPath();
      const amplitude = 40 + j*10;
      const frequency = 0.02 + j*0.01;
      for (let i = 0; i < canvas.width; i++) {
        const x = i;
        const y = canvas.height/2 + Math.sin(i*frequency + step + j*50) * amplitude;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.stroke();
    }

    step += 0.05; // سرعة الحركة
  }

  drawWaves();
</script>
</body>
</html>