<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>مساعد صوتي — خيال الفكرة</title>
<style>
  :root{
    --navy-1:#071428;
    --navy-2:#0b2540;
    --accent:#ffffff;
  }
  html,body{
    margin:0;padding:0;height:100%;
    background:linear-gradient(180deg,var(--navy-1),var(--navy-2));
    font-family:system-ui,Arial,"Segoe UI";
  }

  /* شعار */
  .topbar{
    position:fixed;
    top:16px;left:20px;z-index:5;
    display:flex;align-items:center;gap:12px;
    pointer-events:none;
  }
  .company-logo{
    width:56px;height:56px;object-fit:contain;filter:none;
  }
  .title{
    font-size:14px;font-weight:600;color:#fff;opacity:0.95;
  }

  /* موجات الصوت */
  .wave-wrap{
    position:fixed;
    top:50%;left:0;right:0;transform:translateY(-50%);
    display:flex;justify-content:center;align-items:center;
    z-index:3;pointer-events:none;
    padding:0 20px;
  }
  #waveCanvas{
    width:100%;
    max-width:1200px;
    height:140px;
    border-radius:8px;
    opacity:0.95;
    filter:drop-shadow(0 6px 20px rgba(0,0,0,0.6));
    background:transparent;
  }

  /* عناصر التحكم أسفل الصفحة */
  .controls{
    position:fixed;bottom:20px;z-index:6;
    display:flex;gap:12px;justify-content:center;width:100%;pointer-events:auto;
  }
  button{
    padding:10px 18px;border:0;border-radius:8px;cursor:pointer;
    background:#0b6cff;color:#fff;font-weight:600;
    box-shadow:0 6px 18px rgba(11,108,255,0.12);
  }
  button[disabled]{opacity:0.5;cursor:default;filter:grayscale(0.3);}
  #status{
    position:relative;z-index:6;color:#9eea9e;
    font-family:system-ui,Arial,sans-serif;margin-top:8px;
    pointer-events:none;text-align:center;
  }

  @media (max-width:600px){
    #waveCanvas{ height:90px; }
    .company-logo{ width:40px; height:40px; }
    .title{ font-size:12px; }
    button{ padding:8px 12px; font-size:14px; }
  }
</style>
</head>
<body>

  <!-- شعار الشركة PNG -->
  <div class="topbar">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="logo" class="company-logo">
    <div class="title">مساعد صوتي — خيال الفكرة</div>
  </div>

  <!-- موجات الصوت -->
  <div class="wave-wrap" aria-hidden="true">
    <canvas id="waveCanvas"></canvas>
  </div>

  <!-- عناصر التحكم -->
  <div class="controls">
    <button id="start">بدء المحادثة</button>
    <button id="stop" disabled>إيقاف</button>
  </div>

  <div id="status"></div>

  <!-- صوت البوت -->
  <audio id="agent-audio" autoplay playsinline></audio>

<script type="module">
import { Conversation } from "https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.5.0/+esm";

const startBtn=document.getElementById('start');
const stopBtn=document.getElementById('stop');
const statusEl=document.getElementById('status');
const agentAudio=document.getElementById('agent-audio');

let convo=null;
const setStatus=(t)=>statusEl.textContent=t;

let audioCtx=null, analyser=null, bufferLength=0, dataArray=null;
const canvas=document.getElementById('waveCanvas');
const ctx=canvas.getContext('2d');

function resizeCanvas(){
  const dpr=window.devicePixelRatio||1;
  canvas.width=Math.floor(canvas.clientWidth*dpr);
  canvas.height=Math.floor(canvas.clientHeight*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize',resizeCanvas);
resizeCanvas();

function ensureAudioContext(){
  if(audioCtx&&audioCtx.state!=='closed')return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  try{agentAudio.crossOrigin="anonymous";}catch(e){}
  const source=audioCtx.createMediaElementSource(agentAudio);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=2048;
  analyser.smoothingTimeConstant=0.85;
  source.connect(analyser);
  analyser.connect(audioCtx.destination);
  bufferLength=analyser.fftSize;
  dataArray=new Uint8Array(bufferLength);
}

function resumeAudioContextIfNeeded(){
  if(!audioCtx)return;
  if(audioCtx.state==='suspended')audioCtx.resume().catch(()=>{});
}

function drawWave(){
  if(analyser){
    analyser.getByteTimeDomainData(dataArray);
    ctx.
    clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    const width=canvas.clientWidth;
    const height=canvas.clientHeight;
    const midY=height/2;
    ctx.lineWidth=2;
    ctx.strokeStyle='#ffffff';
    ctx.beginPath();
    const sliceWidth=width/bufferLength;
    let x=0;
    for(let i=0;i<bufferLength;i++){
      const v=dataArray[i]/128.0;
      const y=v*midY;
      if(i===0)ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
      x+=sliceWidth;
    }
    ctx.lineTo(width,midY);
    ctx.stroke();
  }
  requestAnimationFrame(drawWave);
}
drawWave();

async function start(){
  try{
    setStatus('نجهّز المايك…');
    await navigator.mediaDevices.getUserMedia({audio:true});
    setStatus('نجيب توكن الجلسة…');
    const tokenRes=await fetch('/conversation-token');
    if(!tokenRes.ok)throw new Error('فشل جلب التوكن');
    const conversationToken=await tokenRes.text();
    setStatus('نبدأ الجلسة مع رؤى…');
    convo=await Conversation.startSession({
      conversationToken,
      connectionType:"webrtc",
      onConnect:()=>{
        setStatus('متصلة — تكلم معها الآن ✨');
        ensureAudioContext();
        resumeAudioContextIfNeeded();
      },
      onDisconnect:()=>setStatus('انتهت الجلسة'),
      onError:(e)=>setStatus(`خطأ: ${e?.message||e}`),
    });
    const remoteStream=(convo.getRemoteMediaStream&&convo.getRemoteMediaStream())||(convo.getRemoteStream&&convo.getRemoteStream())||null;
    if(remoteStream){
      agentAudio.srcObject=remoteStream;
      try{await agentAudio.play();}catch(e){}
    }
    startBtn.disabled=true;
    stopBtn.disabled=false;
    ensureAudioContext();
    resumeAudioContextIfNeeded();
  }catch(err){setStatus(`خطأ: ${err?.message||err}`);}
}

async function stop(){
  try{if(convo){await convo.endSession();convo=null;}}
  finally{
    startBtn.disabled=false;stopBtn.disabled=true;setStatus('أوقفت الجلسة.');
  }
}

startBtn.addEventListener('click',async()=>{
  ensureAudioContext();resumeAudioContextIfNeeded();await start();
});
stopBtn.addEventListener('click',stop);
document.addEventListener('click',function onFirstClick(){
  ensureAudioContext();resumeAudioContextIfNeeded();
  document.removeEventListener('click',onFirstClick);
},{capture:true,once:true});
</script>
</body>
</html>