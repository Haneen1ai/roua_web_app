<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>واجهة رؤى</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fade-ms: 160; }
    html, body { margin:0; height:100%; background:#000; }
    * { box-sizing: border-box; }

    /* مسرح ملء الشاشة */
    .stage {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      touch-action: none;
    }

    /* الصورة والفيديو نفس المقاس والقص */
    .media {
      position: absolute;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;      /* يملأ الشاشة ويحافظ على النسبة */
      object-position: center;
      -webkit-user-drag: none;
      pointer-events: none;
      transition: opacity var(--fade-ms) linear;
    }
    .bg   { opacity: 1; }
    .talk { opacity: 0; }

    /* أزرار التحكم (كما هي) */
    .controls {
      position: absolute;
      z-index: 10;
      left: 50%;
      bottom: 4vh;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
    }
    button {
      padding: 12px 18px;
      font-size: 16px;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      background: #0a84ff;
      color: #fff;
    }
    button:disabled { opacity: .6; cursor: default; }
  </style>
</head>
<body>
  <div class="stage" id="stage">
    <!-- صورة الخلفية فل سكرين -->
    <img
      src="{{ url_for('static', filename='roua.jpg') }}"
      class="media bg"
      alt="Roa Background"
      draggable="false"
    />

    <!-- فيديو 1s (Blink/حركة بسيطة) ينعاد وقت كلام البوت -->
    <video
      id="talkVideo"
      class="media talk"
      src="{{ url_for('static', filename='roua_blink.mp4') }}"
      muted
      playsinline
      preload="auto"
      loop
      tabindex="-1"
    ></video>

    <!-- الأزرار كما هي -->
    <div class="controls">
      <button id="startBtn">ابدأ المحادثة الصوتية</button>
    </div>
  </div>

  <!-- مسار صوت البوت -->
  <audio id="botAudio" autoplay playsinline></audio>

  <script>
    const startBtn  = document.getElementById('startBtn');
    const botAudio  = document.getElementById('botAudio');
    const talkVideo = document.getElementById('talkVideo');

    // فتح الصوت على المتصفح
    async function unlockAudio() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (ctx.state === 'suspended') await ctx.resume();
        return ctx;
      } catch { return null; }
    }

    // إظهار/إخفاء الفيديو بسلاسة
    const showVideo = (show) => { talkVideo.style.opacity = show ? '1' : '0'; };

    // فالس باك بسيط: معتمِد على أحداث <audio>
    function fallbackMediaEvents() {
      botAudio.addEventListener('playing', () => {
        talkVideo.play().catch(()=>{});
        showVideo(true);
      });
      const stop = () => {
        showVideo(false);
        talkVideo.pause();
        talkVideo.currentTime = 0; // يرجع لأول إطار (شكل ثابت)
      };
      ['pause','ended','emptied','stalled','suspend'].forEach(ev => botAudio.addEventListener(ev, stop));
    }

    // VAD بسيط عبر WebAudio لتحسين التوقيت
    function setupVAD(audioCtx) {
      if (!audioCtx) return fallbackMediaEvents();
      try {
        const src = audioCtx.createMediaElementSource(botAudio);
        const an  = audioCtx.createAnalyser();
        an.fftSize = 2048;
        src.connect(an);
        an.connect(audioCtx.destination);

        const buf = new Uint8Array(an.fftSize);
        let speaking=false, silentTicks=0, speakTicks=0;
        const SILENT_TICKS_TO_HIDE = 6;  // ~6 فريمات سكون
        const SPEAK_TICKS_TO_SHOW  = 2;  // فريمين صوت لإظهار الفيديو
        const THRESHOLD            = 6;  // زوّديها إذا الصوت منخفض

        function tick() {
          an.getByteTimeDomainData(buf);
          let sum=0; for (let i=0;i<buf.length;i++) sum += Math.abs(buf[i]-128);
          const activity = sum / buf.length;

          if (activity > THRESHOLD) {
            speakTicks++; silentTicks=0;
            if (!speaking && speakTicks >= SPEAK_TICKS_TO_SHOW) {
              speaking = true;
              talkVideo.play().catch(()=>{});
              showVideo(true);
            }
          } else {
            silentTicks++; speakTicks=0;
            if (speaking && silentTicks >= SILENT_TICKS_TO_HIDE) {
              speaking = false;
              showVideo(false);
              talkVideo.pause();
              talkVideo.currentTime = 0;
            }
          }
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      } catch {
        fallbackMediaEvents();
      }
    }

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      const audioCtx = await unlockAudio();

      try {
        // 1) تأسيس PeerConnection
        const pc = new RTCPeerConnection({
          iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
        });

        // 2) صوت البوت -> <audio>
        const remoteStream = new MediaStream();
        pc.addEventListener('track', (e) => {
          remoteStream.addTrack(e.track);
          botAudio.srcObject = remoteStream;
          botAudio.muted = false;
          botAudio.volume = 1.0;
          botAudio.play().catch(()=>{});
        });

        // 3) مايك المستخدم
        const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
        mic.getTracks().forEach(t => pc.addTrack(t, mic));

        // 4) Offer وإرساله لـ ElevenLabs (Public Agent → بدون Authorization)
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const resp = await fetch(
          'https://api.elevenlabs.io/v1/convai/conversation/websocket/webrtc',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/sdp' }, // لا Authorization هنا
            body: offer.sdp
          }
        );

        if (!resp.ok) {
          console.error(await resp.text());
          alert('فشل تهيئة اتصال WebRTC مع ElevenLabs');
          startBtn.disabled = false;
          return;
        }

        const answerSdp = await resp.text();
        await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

        // 5) فعّلي كشف الكلام
        setupVAD(audioCtx);

      } catch (err) {
        console.error(err);
        alert('صار خطأ في بدء الاتصال الصوتي');
        startBtn.disabled = false;
      }
    });

    // منع سحب/لمس غير ضروري
    document.addEventListener('dragstart', e => e.preventDefault());
  </script>
</body>
</html>