<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>واجهة رؤى</title>
<style>
  /* صفحة سوداء، بدون سكرول، محاذاة للأزرار */
  html, body { height:100%; }
  body{
    margin:0;background:#000;display:flex;justify-content:center;align-items:center;
    height:100vh;flex-direction:column;gap:16px;overflow:hidden
  }

  /* الخلفية فل سكرين على أي شاشة */
  .bg{
    position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;
    user-select:none;-webkit-user-drag:none;pointer-events:none;background:#000
  }

  /* واجهة التحكم فوق الخلفية */
  .controls{position:relative;z-index:2;display:flex;gap:12px}
  button{padding:10px 18px;border:0;border-radius:8px;cursor:pointer}
  #status{position:relative;z-index:2;color:#9eea9e;font-family:system-ui,Arial,sans-serif}
</style>
</head>
<body>
  <!-- صورة كـ Fallback لو الفيديو ما اشتغل -->
  <img src="{{ url_for('static', filename='roua.jpg') }}" id="bgImg" class="bg" alt="Roa Background">

  <!-- الفيديو الخلفية (Idle) — فل سكرين وLoop -->
  <video id="idleVideo"
         class="bg"
         src="{{ url_for('static', filename='roua.MP4') }}"
         autoplay muted playsinline preload="auto" loop
         style="display:block"></video>

  <div class="controls">
    <button id="start">بدء المحادثة</button>
    <button id="stop" disabled>إيقاف</button>
  </div>
  <div id="status"></div>

  <!-- صوت البوت (منفصل عن الفيديو) -->
  <audio id="agent-audio" autoplay playsinline></audio>

  <script type="module">
    import { Conversation } from "https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.5.0/+esm";

    const startBtn   = document.getElementById('start');
    const stopBtn    = document.getElementById('stop');
    const statusEl   = document.getElementById('status');
    const bgImg      = document.getElementById('bgImg');
    const idleVideo  = document.getElementById('idleVideo');
    const agentAudio = document.getElementById('agent-audio');

    let convo = null;
    const setStatus = (t)=> statusEl.textContent = t;

    /* إذا الفيديو جاهز نخفي الصورة؛ لو فشل نرجّع الصورة */
    idleVideo.addEventListener('canplay', ()=> { bgImg.style.display = 'none'; });
    idleVideo.addEventListener('error',   ()=> { bgImg.style.display = 'block'; });

    async function start() {
      try {
        setStatus('نجهّز المايك…');
        await navigator.mediaDevices.getUserMedia({ audio: true });

        setStatus('نجيب توكن الجلسة…');
        const tokenRes = await fetch('/conversation-token');
        if (!tokenRes.ok) throw new Error('فشل جلب التوكن');
        const conversationToken = await tokenRes.text();

        setStatus('نبدأ الجلسة مع رؤى…');
        convo = await Conversation.startSession({
          conversationToken,
          connectionType: "webrtc",
          onConnect: () => setStatus('متصلة — تكلم معها الآن ✨'),
          onDisconnect: () => setStatus('انتهت الجلسة'),
          onError: (e) => setStatus(`خطأ: ${e?.message || e}`),
        });

        const remoteStream =
          (convo.getRemoteMediaStream && convo.getRemoteMediaStream()) ||
          (convo.getRemoteStream && convo.getRemoteStream()) || null;

        if (remoteStream) {
          agentAudio.srcObject = remoteStream;
          await agentAudio.play().catch(()=>{});
        }

        startBtn.disabled = true;
        stopBtn.disabled  = false;
      } catch (err) {
        setStatus(`خطأ: ${err?.message || err}`);
      }
    }

    async function stop() {
      try {
        if (convo) { await convo.endSession(); convo = null; }
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled  = true;
        setStatus('أوقفت الجلسة.');
      }
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
  </script>
</body>
</html>