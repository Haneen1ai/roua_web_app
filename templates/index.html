<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>واجهة رؤى</title>
<style>
  html, body { height:100%; }
  body{
    margin:0;background:#000;display:flex;justify-content:center;align-items:center;
    height:100vh;flex-direction:column;gap:16px;overflow:hidden
  }
  /* الفيديو خلفية فل سكرين على أي شاشة */
  .bg{
    position:fixed;inset:0;
    width:100vw;height:100vh;
    object-fit:cover;            /* يملأ الشاشة بدون تشويه */
    user-select:none;-webkit-user-drag:none;pointer-events:none;
    background:#000;
  }
  .controls{
    position:fixed;              /* تثبيت في الأسفل */
    bottom:20px;                 /* مسافة من أسفل الشاشة */
    left:50%;transform:translateX(-50%);
    z-index:2;display:flex;gap:12px
  }
  button{padding:10px 18px;border:0;border-radius:8px;cursor:pointer}
  button#start { 
    background:#006C35;  /* أخضر وطني */
    color:#fff; 
  }
  button#stop { 
    background:#014421;  /* أخضر داكن */
    color:#fff; 
  }
  #status{
    position:relative;z-index:2;
    color:#3399ff;  /* أزرق فاتح */
    font-family:system-ui,Arial,sans-serif
  }
</style>
</head>
<body>
  <!-- الفيديو: خلفية أساسية دائمة -->
  <video id="bgVideo"
         class="bg"
         src="{{ url_for('static', filename='roua.MP4') }}"
         autoplay muted playsinline preload="auto" loop>
  </video>

  <div class="controls">
    <button id="start">بدء المحادثة</button>
    <button id="stop" disabled>إيقاف</button>
  </div>
  <div id="status"></div>

  <!-- صوت البوت (منفصل عن الخلفية) -->
  <audio id="agent-audio" autoplay playsinline></audio>

  <script type="module">
    import { Conversation } from "https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.5.0/+esm";

    const startBtn   = document.getElementById('start');
    const stopBtn    = document.getElementById('stop');
    const statusEl   = document.getElementById('status');
    const agentAudio = document.getElementById('agent-audio');
    const bgVideo    = document.getElementById('bgVideo');

    let convo = null;
    const setStatus = (t)=> statusEl.textContent = t;

    /* ضمان التشغيل الفوري وإعادة المحاولة لو رفض المتصفح */
    bgVideo.addEventListener('canplay', () => { bgVideo.play().catch(()=>{}); });
    bgVideo.play().catch(()=>{}); // محاولة أولى

    async function start() {
      try {
        setStatus('نجهّز المايك…');
        await navigator.mediaDevices.getUserMedia({ audio: true });

        setStatus('نجيب توكن الجلسة…');
        const tokenRes = await fetch('/conversation-token');
        if (!tokenRes.ok) throw new Error('فشل جلب التوكن');
        const conversationToken = await tokenRes.text();

        setStatus('نبدأ الجلسة مع رؤى…');
        convo = await Conversation.startSession({
          conversationToken,
          connectionType: "webrtc",
          onConnect: () => setStatus('متصلة — تكلم معها الآن ✨'),
          onDisconnect: () => setStatus('انتهت الجلسة'),
          onError: (e) => setStatus(`خطأ: ${e?.message || e}`),
        });

        const remoteStream =
          (convo.getRemoteMediaStream && convo.getRemoteMediaStream()) ||
          (convo.getRemoteStream && convo.getRemoteStream()) || null;

        if (remoteStream) {
          agentAudio.srcObject = remoteStream;
          await agentAudio.play().catch(()=>{});
        }

        startBtn.disabled = true;
        stopBtn.disabled  = false;
      } catch (err) {
        setStatus(`خطأ: ${err?.message || err}`);
      }
    }

    async function stop() {
      try {
        if (convo) { await convo.endSession(); convo = null; }
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled  = true;
        setStatus('أوقفت الجلسة.');
      }
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
  </script>
</body>
</html>
