<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Voice Bot</title>
</head>
<body>
  <button id="startBtn">ابدأ</button>
  <audio id="botAudio" autoplay></audio>
  <video id="botVideo" width="400" style="display:none;" loop>
    <source src="video.mp4" type="video/mp4">
  </video>

  <script>
    const startBtn = document.getElementById("startBtn");
    const botAudio = document.getElementById("botAudio");
    const botVideo = document.getElementById("botVideo");

    startBtn.onclick = async () => {
      startBtn.disabled = true;

      // 1) جلب التوكن
      const resp = await fetch('/conversation-token', { cache: 'no-store' });
      const token = await resp.text();
      if (!token  token.startsWith("Missing")  token.startsWith("Failed")) {
        alert("فشل جلب التوكن من السيرفر");
        startBtn.disabled = false;
        return;
      }

      // 2) تاسيس اتصال WebRTC
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
      });

      const remoteStream = new MediaStream();
      botAudio.srcObject = remoteStream;

      pc.ontrack = (event) => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
      };

      // 3) الفيديو يشتغل مع الصوت
      botAudio.onplay = () => { botVideo.style.display = "block"; botVideo.play(); };
      botAudio.onpause = () => { botVideo.pause(); botVideo.style.display = "none"; };
      botAudio.onended = () => { botVideo.pause(); botVideo.style.display = "none"; };

      // باقي كود الـ offer/answer حسب سيرفرك...
    };
  </script>
</body>
</html>