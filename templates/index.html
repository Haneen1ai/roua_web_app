<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>واجهة رؤى</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <style>
    html, body { margin:0; height:100%; background:#000; overflow:hidden; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Arabic",sans-serif; }
    .container { position:relative; width:100%; height:100%; }
    /* الخلفية: تغطي الشاشة كاملة */
    img.bg {
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      user-select:none; -webkit-user-drag:none; pointer-events:none;
    }
    /* الشريط السفلي (التعليقات + الزر) */
    .controls {
      position:absolute; left:50%; bottom:28px; transform:translateX(-50%);
      display:flex; flex-direction:column; align-items:center; gap:12px;
    }
    .status {
      color:#9ee; font-size:24px; font-weight:700;
      text-shadow:0 0 6px #000;
      display:flex; align-items:center; gap:10px; min-height:28px;
    }
    .dot { width:12px; height:12px; border-radius:50%; background:#888; opacity:.7; }
    .status.user .dot { background:#3ad63a; animation:pulse 1.2s infinite; }
    .status.bot  .dot { background:#1e90ff; animation:blink .6s infinite; }
    @keyframes pulse { 0%{transform:scale(.9)} 50%{transform:scale(1.12)} 100%{transform:scale(.9)} }
    @keyframes blink { 0%,100%{opacity:.4} 50%{opacity:1} }

    button {
      padding:14px 22px; font-size:20px; font-weight:800;
      border:0; border-radius:10px; background:#1e90ff; color:#fff; cursor:pointer;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <!-- الخلفية (الصورة تغطي الواجهة كاملة) -->
    <img src="/static/roua.jpg" class="bg" alt="رؤى" />

    <!-- الشريط السفلي: التعليقات + زر البدء/الإيقاف -->
    <div class="controls">
      <div id="status" class="status">
        <span class="dot"></span><span id="statusText">اضغطي "بدء المحادثة" للبدء</span>
      </div>
      <button id="startBtn">بدء المحادثة الصوتية</button>
    </div>
  </div>

  <!-- عنصر صوت البوت -->
  <audio id="botAudio" autoplay playsinline></audio>

  <script>
    const startBtn = document.getElementById('startBtn');
    const botAudio = document.getElementById('botAudio');
    const statusEl = document.getElementById('status');
    const statusText = document.getElementById('statusText');

    let pc = null;          // PeerConnection الحالي
    let micStream = null;   // ستريم المايك الحالي
    let audioCtx = null;    // AudioContext لمؤشر الكلام
    let vadTimer = null;    // مؤقت فحص الصوت

    function setStatus(text, mode) {
      statusText.textContent = text;
      statusEl.classList.remove('user', 'bot');
      if (mode) statusEl.classList.add(mode);
    }

    async function unlockAudio() {
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
      } catch (_) { audioCtx = null; }
    }

    function stopAll() {
      try { if (vadTimer) clearInterval(vadTimer); vadTimer = null; } catch(_) {}
      try { if (pc) pc.close(); } catch(_) {}
      pc = null;
      try { if (micStream) micStream.getTracks().forEach(t => t.stop()); } catch(_) {}
      micStream = null;
      setStatus('أوقِفت الجلسة. اضغطي "بدء المحادثة" للبدء', null);
      startBtn.textContent = 'بدء المحادثة الصوتية';
      startBtn.disabled = false;
    }

    async function startSession() {
      startBtn.disabled = true;
      setStatus('جاري التوصيل...', null);
      await unlockAudio();

      try {
        // 1) الحصول على التوكن من الباك-إند
        const respTok = await fetch('/conversation-token');
        const token = await respTok.text();
        if (!token  token.startsWith('Missing')  token.startsWith('Failed')) {
          alert('فشل جلب التوكن من السيرفر');
          stopAll(); return;
        }

        // 2) إنشاء اتصال WebRTC
        pc = new RTCPeerConnection({ iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] });

        // 3) استلام صوت البوت إلى <audio>
        const remoteStream = new MediaStream();
        pc.addEventListener('track', (e) => {
          remoteStream.addTrack(e.track);
          botAudio.srcObject = remoteStream;
          botAudio.muted = false;
          botAudio.play().catch(()=>{});
        });

        // VAD مبسّط لصوت البوت → يبدّل التعليقات
        if (audioCtx) {
          const botSource = audioCtx.createMediaStreamSource(remoteStream);
          const analyser = audioCtx.createAnalyser();
          analyser.fftSize = 2048;
          botSource.connect(analyser);
          const buf = new Uint8Array(analyser.fftSize);
          let speaking = false; const THRESH = 12; const EVERY = 120;

          vadTimer = setInterval(() => {
            analyser.getByteTimeDomainData(buf);
            let sum = 0; for (let i=0;i<buf.length;i++) sum += Math.abs(buf[i]-128);
            const level = sum / buf.length;
            if (!speaking && level > THRESH) { speaking = true; setStatus('يتكلم الآن…', 'bot'); }
            else if (speaking && level <= THRESH) { speaking = false; setStatus('تكلم الآن', 'user'); }
          }, EVERY);
        }

        // 4) إضافة صوت المستخدم
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStream.getTracks().forEach(t => pc.addTrack(t, micStream));
        setStatus('تكلم الآن', 'user');

        // 5) Offer → ElevenLabs (ضعي توكنك في /conversation-token بالباك-إند)
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const resp = await fetch('https://api.elevenlabs.io/v1/convai/conversation/websocket/webrtc', {
          method: 'POST',
          headers: { 'Authorization': Bearer ${token}, 'Content-Type': 'application/sdp' },
          body: offer.sdp
        });

        if (!resp.ok) {
          console.error(await resp.text());
          alert('فشل تهيئة اتصال WebRTC مع المزود');
          stopAll(); return;
        }

        const answerSdp = await resp.text();
        await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

        // زر يتحول إلى "إيقاف"
        startBtn.textContent = 'إيقاف المحادثة';
        startBtn.disabled = false;

      } catch (err) {
        console.error(err);
        alert('صار خطأ في بدء الاتصال الصوتي');
        stopAll();
      }
    }

    // تبديل بدء/إيقاف
    startBtn.addEventListener('click', async () => {
      if (!pc) {
        await startSession();
      } else {
        stopAll();
      }
    });

    // تنظيف عند إغلاق/تحديث الصفحة
    window.addEventListener('beforeunload', stopAll);
  </script>
</body>
</html>