let sum = 0; for (let i=0;i<buf.length;i++) sum += Math.abs(buf[i]-128);
            const level = sum / buf.length;
            if (!speaking && level > THRESH) {
              speaking = true; setStatus('البوت يتكلم الآن…', 'bot');
            } else if (speaking && level <= THRESH) {
              speaking = false; setStatus('تكلم الآن', 'user');
            }
          }, 120);
        }

        const mic = await navigator.mediaDevices.getUserMedia({ audio: true });
        mic.getTracks().forEach(t => pc.addTrack(t, mic));
        setStatus('تكلم الآن', 'user');

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const resp = await fetch(
          'https://api.elevenlabs.io/v1/convai/conversation/websocket/webrtc',
          {
            method: 'POST',
            headers: { 'Authorization': Bearer ${token}, 'Content-Type': 'application/sdp' },
            body: offer.sdp
          }
        );

        if (!resp.ok) {
          console.error(await resp.text());
          alert('فشل تهيئة اتصال WebRTC مع المزود');
          startBtn.disabled = false; setStatus('فشل البدء. أعيدي المحاولة.', null); return;
        }

        const answerSdp = await resp.text();
        await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

      } catch (err) {
        console.error(err);
        alert('صار خطأ في بدء الاتصال الصوتي');
        startBtn.disabled = false; setStatus('فشل البدء. أعيدي المحاولة.', null);
      }
    });
  </script>
</body>
</html>