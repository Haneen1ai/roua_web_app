<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>واجهة رؤى</title>
<style>
  body{
    margin:0;background:#000;display:flex;justify-content:center;align-items:center;
    height:100vh;flex-direction:column;gap:16px;overflow:hidden
  }
  /* الخلفية (صورة/فيديو) تغطي الشاشة بالكامل */
  .bg{
    position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;user-select:none;
    -webkit-user-drag:none;pointer-events:none;background:#000
  }
  /* نخلي زرّين والتحكم ظاهرين فوق الخلفية */
  .controls{position:relative;z-index:2;display:flex;gap:12px}
  button{padding:10px 18px;border:0;border-radius:8px;cursor:pointer}
  #status{position:relative;z-index:2;color:#9eea9e;font-family:system-ui,Arial,sans-serif}
</style>
</head>
<body>
  <!-- الصورة الافتراضية -->
  <img src="{{ url_for('static', filename='roua.jpg') }}" id="bgImg" class="bg" alt="Roa Background">

  <!-- الفيديو الذي يظهر أثناء كلام البوت -->
  <video id="rouaVideo"
         class="bg"
         src="{{ url_for('static', filename='roua.MP4') }}"
         preload="auto"
         muted
         playsinline
         loop
         style="display:none"></video>

  <div class="controls">
    <button id="start">بدء المحادثة</button>
    <button id="stop" disabled>إيقاف</button>
  </div>
  <div id="status"></div>

  <!-- صوت الخرج من البوت -->
  <audio id="agent-audio" autoplay playsinline></audio>

  <script type="module">
    // نستورد عميل ElevenLabs (يدعم WebRTC/WebSocket). هذا مسار ESM من jsdelivr.
    import { Conversation } from "https://cdn.jsdelivr.net/npm/@elevenlabs/client@0.5.0/+esm";

    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');
    const statusEl = document.getElementById('status');
    const bgImg    = document.getElementById('bgImg');
    const vid      = document.getElementById('rouaVideo');

    let convo = null;

    function setStatus(t){ statusEl.textContent = t; }

    function showVideo(){
      if (bgImg) bgImg.style.display = 'none';
      if (vid){
        vid.style.display = 'block';
        // نضمن التشغيل فورًا (ميوت لتفادي قيود المتصفح)
        vid.play().catch(()=>{});
      }
    }

    function showImage(){
      if (vid){
        vid.pause();
        vid.currentTime = 0;
        vid.style.display = 'none';
      }
      if (bgImg) bgImg.style.display = 'block';
    }

    async function start() {
      try {
        setStatus('نجهّز المايك…');
        await navigator.mediaDevices.getUserMedia({ audio: true });

        setStatus('نجيب توكن الجلسة…');
        const tokenRes = await fetch('/conversation-token');
        if (!tokenRes.ok) throw new Error('فشل جلب التوكن');
        const conversationToken = await tokenRes.text();

        setStatus('نبدأ الجلسة مع رؤى…');
        convo = await Conversation.startSession({
          conversationToken,
          connectionType: "webrtc",   // مباشر
          onConnect: () => setStatus('متصلة — تكلم معها الآن ✨'),
          onDisconnect: () => { setStatus('انتهت الجلسة'); showImage(); },
          onError: (e) => setStatus(`خطأ: ${e?.message || e}`),

          // يبدأ كلام البوت -> شغّل الفيديو
          onAgentResponseStart: () => { showVideo(); },

          // انتهى كلام البوت/سكت -> ارجع للصورة
          onAgentResponseStop: () => { showImage(); },

          onMessage: (m) => {
            // تراك النصوص (اختياري)
            // console.log('msg', m);
          },
        });

        // افتراضيًا نعرض الصورة
        showImage();

        startBtn.disabled = true;
        stopBtn.disabled  = false;
      } catch (err) {
        setStatus(`خطأ: ${err?.message || err}`);
      }
    }

    async function stop() {
      try {
        if (convo) {
          await convo.endSession();
          convo = null;
        }
      } finally {
        startBtn.disabled = false;
        stopBtn.disabled  = true;
        showImage();
        setStatus('أوقفت الجلسة.');
      }
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
  </script>
</body>
</html>